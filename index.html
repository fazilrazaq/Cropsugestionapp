<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crop Suggestion & NPK Inspection System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            width: 100%;
            max-width: 800px;
            min-height: 600px;
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255,255,255,0.1) 10px,
                rgba(255,255,255,0.1) 20px
            );
            animation: slide 20s linear infinite;
        }

        @keyframes slide {
            0% { transform: translateX(-50px); }
            100% { transform: translateX(50px); }
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .content {
            padding: 40px;
        }

        .step {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4CAF50;
            background: white;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 10px 5px;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }

        .btn-secondary:hover {
            box-shadow: 0 10px 20px rgba(108, 117, 125, 0.3);
        }

        .crop-suggestions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .crop-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 20px;
            border-left: 5px solid #4CAF50;
            transition: transform 0.3s ease;
        }

        .crop-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }

        .crop-card h3 {
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .npk-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .npk-card {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .npk-card h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .setpoint-group {
            margin-bottom: 10px;
        }

        .setpoint-group input {
            padding: 8px 12px;
            margin: 2px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 8px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
        }

        .success {
            color: #28a745;
            font-size: 14px;
            margin-top: 5px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e9ecef;
            margin: 0 5px;
            transition: all 0.3s ease;
        }

        .step-dot.active {
            background: #4CAF50;
            transform: scale(1.2);
        }

        .inspection-schedule {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .service-option {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }

        .service-card {
            flex: 1;
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .service-card:hover {
            border-color: #4CAF50;
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(76, 175, 80, 0.1);
        }

        .service-card.selected {
            border-color: #4CAF50;
            background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
        }

        .unique-id {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .unique-id h3 {
            color: #f57c00;
            margin-bottom: 10px;
        }

        .unique-id-code {
            font-family: 'Courier New', monospace;
            font-size: 1.5em;
            font-weight: bold;
            color: #e65100;
            background: white;
            padding: 10px;
            border-radius: 8px;
            display: inline-block;
        }

        .report-section {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .firebase-status {
            background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            border-left: 4px solid #4CAF50;
        }

        .firebase-status.loading {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left-color: #ff9800;
        }

        .firebase-status.error {
            background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
            border-left-color: #f44336;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .content {
                padding: 20px;
            }
            
            .service-option {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåæ Crop Suggestion & NPK System</h1>
            <p>Smart Agriculture Management Platform for Tamil Nadu</p>
        </div>

        <div class="content">
            <div class="step-indicator">
                <div class="step-dot active" id="dot-1"></div>
                <div class="step-dot" id="dot-2"></div>
                <div class="step-dot" id="dot-3"></div>
                <div class="step-dot" id="dot-4"></div>
                <div class="step-dot" id="dot-5"></div>
                <div class="step-dot" id="dot-6"></div>
            </div>

            <!-- Step 1: Login -->
            <div class="step active" id="step-1">
                <h2>üîê Login to Your Account</h2>
                <div style="background: #e8f5e8; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #4CAF50;">
                    <h4 style="margin: 0 0 10px 0; color: #2e7d32;">Valid Credentials:</h4>
                    <p style="margin: 5px 0; font-family: monospace;"><strong>Email:</strong> mohamedfazilrazaq@gmail.com</p>
                    <p style="margin: 5px 0; font-family: monospace;"><strong>Password:</strong> fazil2024</p>
                    <hr style="margin: 10px 0; border: none; border-top: 1px solid #ccc;">
                    <p style="margin: 5px 0; font-family: monospace; font-size: 0.9em;"><strong>Demo:</strong> farmer@tnagri.gov.in / TN2024</p>
                </div>
                <div class="form-group">
                    <label for="email">Email ID:</label>
                    <input type="email" id="email" placeholder="Enter your email address" value="mohamedfazilrazaq@gmail.com" required>
                    <div class="error" id="email-error"></div>
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" placeholder="Enter your password" value="fazil2024" required>
                    <div class="error" id="password-error"></div>
                </div>
                <button class="btn" onclick="validateLogin()">Login & Continue</button>
            </div>

            <!-- Step 2: District Selection -->
            <div class="step" id="step-2">
                <h2>üìç Select Your District</h2>
                <div class="form-group">
                    <label for="district">District in Tamil Nadu:</label>
                    <select id="district" required>
                        <option value="">Select your district</option>
                        <option value="Chennai">Chennai</option>
                        <option value="Coimbatore">Coimbatore</option>
                        <option value="Salem">Salem</option>
                        <option value="Madurai">Madurai</option>
                        <option value="Tiruchirappalli">Tiruchirappalli</option>
                        <option value="Tirunelveli">Tirunelveli</option>
                        <option value="Thanjavur">Thanjavur</option>
                        <option value="Vellore">Vellore</option>
                        <option value="Erode">Erode</option>
                        <option value="Tiruppur">Tiruppur</option>
                        <option value="Dindigul">Dindigul</option>
                        <option value="Karur">Karur</option>
                        <option value="Villupuram">Villupuram</option>
                        <option value="Sivaganga">Sivaganga</option>
                        <option value="Nagapattinam">Nagapattinam</option>
                    </select>
                    <div class="error" id="district-error"></div>
                </div>
                <button class="btn btn-secondary" onclick="previousStep()">Back</button>
                <button class="btn" onclick="validateDistrict()">Continue</button>
            </div>

            <!-- Step 3: Crop Suggestions -->
            <div class="step" id="step-3">
                <h2>üå± Crop Suggestions for <span id="selected-district"></span></h2>
                <div class="crop-suggestions" id="crop-suggestions"></div>
                <button class="btn btn-secondary" onclick="previousStep()">Back</button>
                <button class="btn" onclick="nextStep()">Continue to NPK Inspection</button>
            </div>

            <!-- Step 4: NPK Inspection Schedule -->
            <div class="step" id="step-4">
                <h2>üìÖ NPK Inspection Schedule</h2>
                <div class="inspection-schedule">
                    <h3>Scheduled Inspection Dates:</h3>
                    <div style="display: grid; gap: 15px; margin-top: 20px;">
                        <div>
                            <label><strong>üü¢ Nitrogen Inspection:</strong></label>
                            <input type="date" id="nitrogen-date" style="margin-left: 10px;">
                        </div>
                        <div>
                            <label><strong>üî¥ Phosphorous Inspection:</strong></label>
                            <input type="date" id="phosphorous-date" style="margin-left: 10px;">
                        </div>
                        <div>
                            <label><strong>üü° Potassium Inspection:</strong></label>
                            <input type="date" id="potassium-date" style="margin-left: 10px;">
                        </div>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="previousStep()">Back</button>
                <button class="btn" onclick="nextStep()">Continue</button>
            </div>

            <!-- Step 5: Service Selection -->
            <div class="step" id="step-5">
                <h2>üöÅ Choose NPK Measurement Method</h2>
                <p style="margin-bottom: 20px;">How would you like to measure NPK values?</p>
                
                <div class="service-option">
                    <div class="service-card" onclick="selectService('drone')" id="drone-card">
                        <h3>üöÅ Drone Service</h3>
                        <p>Professional drone inspection with automated NPK measurement</p>
                        <ul style="text-align: left; margin-top: 15px;">
                            <li>‚úÖ High accuracy readings</li>
                            <li>‚úÖ 5 measurement points per nutrient</li>
                            <li>‚úÖ Detailed mapping report</li>
                            <li>‚úÖ Expert analysis</li>
                        </ul>
                    </div>
                    <div class="service-card" onclick="selectService('manual')" id="manual-card">
                        <h3>‚úã Manual Entry</h3>
                        <p>Enter NPK values manually from your own testing</p>
                        <ul style="text-align: left; margin-top: 15px;">
                            <li>‚úÖ Use your own test results</li>
                            <li>‚úÖ Quick data entry</li>
                            <li>‚úÖ Immediate processing</li>
                            <li>‚úÖ Cost-effective option</li>
                        </ul>
                    </div>
                </div>
                
                <div class="unique-id" id="unique-id-section" style="display: none;">
                    <h3>Your Unique Service ID:</h3>
                    <div class="unique-id-code" id="service-id"></div>
                    <p style="margin-top: 10px;">Please save this ID for tracking your drone inspection</p>
                </div>
                
                <button class="btn btn-secondary" onclick="previousStep()">Back</button>
                <button class="btn" onclick="nextStep()" id="service-continue-btn" disabled>Continue</button>
            </div>

            <!-- Step 6: NPK Values Input -->
            <div class="step" id="step-6">
                <h2 id="npk-title">üìä NPK Values</h2>
                
                <!-- Firebase Status Display -->
                <div class="firebase-status" id="firebase-status" style="display: none;">
                    <div class="loading-spinner" id="loading-spinner" style="display: none;"></div>
                    <span id="status-message">Connecting to Firebase...</span>
                </div>
                
                <!-- Firebase Test Button (for debugging) -->
                <div style="margin: 20px 0; text-align: center;">
                    <button class="btn btn-secondary" onclick="testFirebaseConnection()" id="firebase-test-btn">üîß Test Firebase Connection</button>
                </div>
                
                <div class="npk-inputs">
                    <div class="npk-card">
                        <h4>üü¢ Nitrogen (N) Values</h4>
                        <div id="nitrogen-inputs"></div>
                    </div>
                    <div class="npk-card">
                        <h4>üî¥ Phosphorous (P) Values</h4>
                        <div id="phosphorous-inputs"></div>
                    </div>
                    <div class="npk-card">
                        <h4>üü° Potassium (K) Values</h4>
                        <div id="potassium-inputs"></div>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="previousStep()">Back</button>
                <button class="btn" onclick="generateReport()">Generate Report</button>
            </div>

            <!-- Step 7: Final Report -->
            <div class="step" id="step-7">
                <h2>üìã Analysis Report</h2>
                <div class="report-section" id="final-report">
                    <!-- Report content will be generated here -->
                </div>
                <button class="btn" onclick="exportReport()">üì§ Export Report</button>
                <button class="btn btn-secondary" onclick="restartProcess()">üîÑ Start New Analysis</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK v9 - Direct CDN loading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA4VvlvaYkd80-GW2urwSbTAINu2YxkUo0",
            authDomain: "agriculture-esp32.firebaseapp.com",
            databaseURL: "https://agriculture-esp32-default-rtdb.firebaseio.com",
            projectId: "agriculture-esp32",
            storageBucket: "agriculture-esp32.firebasestorage.app",
            messagingSenderId: "471441452005",
            appId: "1:471441452005:web:02b2bf57269d3e9ac6dd0c"
        };

        // Initialize Firebase when page loads
        window.addEventListener('load', function() {
            setTimeout(() => {
                console.log('Attempting Firebase initialization...');
                
                if (typeof firebase === 'undefined') {
                    console.error('Firebase SDK failed to load from CDN');
                    useFallbackData();
                    return;
                }
                
                try {
                    firebase.initializeApp(firebaseConfig);
                    const database = firebase.database();
                    
                    console.log('Firebase initialized successfully');
                    
                    // Test connection with your actual database
                    database.ref('npk').once('value')
                        .then((snapshot) => {
                            const data = snapshot.val();
                            console.log('Firebase data retrieved:', data);
                            
                            if (data) {
                                setupFirebaseConnection(database);
                            } else {
                                console.log('No data found at /npk path');
                                setupFirebaseConnection(database); // Still set up connection
                            }
                        })
                        .catch((error) => {
                            console.error('Firebase connection error:', error);
                            if (error.code === 'PERMISSION_DENIED') {
                                console.log('Permission denied - check Firebase rules');
                            }
                            useFallbackData();
                        });
                        
                } catch (error) {
                    console.error('Firebase initialization failed:', error);
                    useFallbackData();
                }
            }, 1000);
        });
        
        function setupFirebaseConnection(database) {
            window.firebaseDB = {
                ref: (path) => database.ref(path)
            };
            window.firebaseRef = (db, path) => db.ref(path);
            window.firebaseOnValue = (ref, callback, errorCallback) => {
                ref.on('value', callback, errorCallback);
                return callback;
            };
            window.firebaseOff = (ref, eventType, callback) => {
                ref.off(eventType, callback);
            };
            
            console.log('Firebase connection established');
            window.firebaseConnected = true;
        }
        
        function useFallbackData() {
            console.log('Using fallback mock Firebase interface...');
            
            const mockData = {
                nitrogen: {
                    setpoint1: 45.2,
                    setpoint2: 42.8,
                    setpoint3: 46.1,
                    setpoint4: 44.5,
                    setpoint5: 43.9,
                    average: 44.5
                },
                phosphorous: {
                    setpoint1: 18.3,
                    setpoint2: 19.1,
                    setpoint3: 17.8,
                    setpoint4: 18.9,
                    setpoint5: 18.5,
                    average: 18.5
                },
                potassium: {
                    setpoint1: 125.4,
                    setpoint2: 123.7,
                    setpoint3: 126.8,
                    setpoint4: 124.2,
                    setpoint5: 125.1,
                    average: 124.6
                }
            };
            
            // Create mock Firebase interface
            window.firebaseDB = {
                ref: (path) => ({
                    on: (eventType, callback) => {
                        if (eventType === 'value') {
                            setTimeout(() => {
                                callback({
                                    val: () => mockData,
                                    exists: () => true
                                });
                            }, 500);
                        }
                    },
                    off: () => {},
                    once: (eventType) => {
                        return Promise.resolve({
                            val: () => mockData,
                            exists: () => true
                        });
                    }
                })
            };
            
            window.firebaseRef = (db, path) => db.ref(path);
            window.firebaseOnValue = (ref, callback) => {
                ref.on('value', callback);
                return callback;
            };
            window.firebaseOff = (ref, eventType, callback) => {
                ref.off(eventType, callback);
            };
            
            window.firebaseUsingSampleData = true;
            console.log('Mock Firebase interface ready with sample data');
        }
    </script>

    <script>
        // Global variables
        let currentStep = 1;
        let selectedService = '';
        let userData = {};
        let firebaseListeners = [];

        // Tamil Nadu districts with crop suggestions
        const districtCrops = {
            'Chennai': [
                { name: 'Paddy', variety: 'ADT 45, BPT 5204', period: 'June-July, Nov-Dec', duration: '120-130 days' },
                { name: 'Groundnut', variety: 'TMV 7, VRI 2', period: 'June-July', duration: '100-110 days' }
            ],
            'Coimbatore': [
                { name: 'Cotton', variety: 'MCU 5, SVPR 2', period: 'June-July', duration: '180-200 days' },
                { name: 'Maize', variety: 'COH(M) 5, NK 6240', period: 'June-July, Jan-Feb', duration: '100-110 days' },
                { name: 'Sugarcane', variety: 'Co 86032, Co 8021', period: 'Jan-Mar, Oct-Dec', duration: '10-12 months' }
            ],
            'Salem': [
                { name: 'Paddy', variety: 'ADT 43, Co 47', period: 'June-July, Dec-Jan', duration: '120-140 days' },
                { name: 'Sugarcane', variety: 'Co 62175, Co 86032', period: 'Jan-Mar', duration: '10-12 months' },
                { name: 'Millets', variety: 'Co 9, TNAU 164', period: 'June-July', duration: '75-85 days' }
            ],
            'Madurai': [
                { name: 'Cotton', variety: 'SVPR 1, MCU 5', period: 'June-July', duration: '160-180 days' },
                { name: 'Groundnut', variety: 'TMV 7, ALR 2', period: 'June-July', duration: '100-120 days' },
                { name: 'Sorghum', variety: 'Co 26, K 8', period: 'June-July', duration: '90-110 days' }
            ],
            'Thanjavur': [
                { name: 'Paddy', variety: 'TKM 9, ADT 36', period: 'June-July, Dec-Jan', duration: '120-135 days' },
                { name: 'Sugarcane', variety: 'Co 8021, Co 94012', period: 'Dec-Feb', duration: '10-12 months' }
            ],
            'Tiruchirappalli': [
                { name: 'Paddy', variety: 'ADT 39, Co 47', period: 'June-July, Nov-Dec', duration: '120-130 days' },
                { name: 'Sugarcane', variety: 'Co 62175, Co 8021', period: 'Jan-Feb', duration: '10-12 months' },
                { name: 'Groundnut', variety: 'VRI 2, TMV 7', period: 'June-July', duration: '105-115 days' }
            ],
            'Tirunelveli': [
                { name: 'Paddy', variety: 'ADT 45, TKM 9', period: 'June-July, Dec-Jan', duration: '110-125 days' },
                { name: 'Cotton', variety: 'SVPR 2, MCU 7', period: 'June-August', duration: '160-180 days' }
            ],
            'Vellore': [
                { name: 'Groundnut', variety: 'TMV 7, VRI 2', period: 'June-July', duration: '100-110 days' },
                { name: 'Paddy', variety: 'ADT 43, BPT 5204', period: 'June-July', duration: '120-130 days' },
                { name: 'Sugarcane', variety: 'Co 86032', period: 'Jan-Mar', duration: '10-12 months' }
            ],
            'Erode': [
                { name: 'Cotton', variety: 'MCU 5, SVPR 1', period: 'June-July', duration: '180-200 days' },
                { name: 'Turmeric', variety: 'BSR 2, Co 1', period: 'June-July', duration: '7-9 months' },
                { name: 'Sugarcane', variety: 'Co 8021, Co 94012', period: 'Dec-Feb', duration: '10-12 months' }
            ],
            'Tiruppur': [
                { name: 'Cotton', variety: 'SVPR 2, MCU 7', period: 'June-July', duration: '170-190 days' },
                { name: 'Maize', variety: 'Co 6, NK 6240', period: 'June-July', duration: '90-100 days' }
            ],
            'Dindigul': [
                { name: 'Cotton', variety: 'MCU 5, SVPR 1', period: 'June-August', duration: '160-180 days' },
                { name: 'Groundnut', variety: 'VRI 2, TMV 7', period: 'June-July', duration: '100-115 days' },
                { name: 'Banana', variety: 'Robusta, Rasthali', period: 'Year round', duration: '11-15 months' }
            ],
            'Karur': [
                { name: 'Cotton', variety: 'SVPR 2, MCU 7', period: 'June-July', duration: '170-185 days' },
                { name: 'Sugarcane', variety: 'Co 8021, Co 86032', period: 'Jan-Mar', duration: '10-12 months' },
                { name: 'Paddy', variety: 'ADT 39, Co 47', period: 'June-July', duration: '120-130 days' }
            ],
            'Villupuram': [
                { name: 'Paddy', variety: 'ADT 43, BPT 5204', period: 'June-July, Nov-Dec', duration: '115-125 days' },
                { name: 'Groundnut', variety: 'TMV 7, VRI 2', period: 'June-July', duration: '100-110 days' },
                { name: 'Sugarcane', variety: 'Co 62175, Co 86032', period: 'Dec-Feb', duration: '10-12 months' }
            ],
            'Sivaganga': [
                { name: 'Cotton', variety: 'SVPR 1, MCU 5', period: 'June-August', duration: '160-180 days' },
                { name: 'Groundnut', variety: 'ALR 2, TMV 7', period: 'June-July', duration: '105-120 days' },
                { name: 'Sorghum', variety: 'Co 26, K 8', period: 'June-July', duration: '90-105 days' }
            ],
            'Nagapattinam': [
                { name: 'Paddy', variety: 'TKM 9, ADT 36', period: 'June-July, Dec-Jan', duration: '120-135 days' },
                { name: 'Coconut', variety: 'East Coast Tall, Chowghat Orange Dwarf', period: 'Year round', duration: '6-10 years to bear' }
            ]
        };

        // Firebase Integration Functions
        function initializeFirebaseConnection() {
            const statusDiv = document.getElementById('firebase-status');
            const statusMessage = document.getElementById('status-message');
            const spinner = document.getElementById('loading-spinner');
            
            statusDiv.style.display = 'block';
            statusDiv.className = 'firebase-status loading';
            spinner.style.display = 'inline-block';
            statusMessage.textContent = 'Connecting to Firebase...';
            
            // Wait a bit for Firebase to initialize
            setTimeout(() => {
                // Check if Firebase is initialized
                if (!window.firebaseDB) {
                    if (window.firebaseError) {
                        showFirebaseError(`Firebase initialization failed: ${window.firebaseError.message}`);
                        console.error('Firebase Error Details:', window.firebaseError);
                    } else {
                        showFirebaseError('Firebase connection timeout. Please check your internet connection.');
                        console.log('Firebase initialization timeout - window.firebaseDB not available');
                    }
                    setupNPKInputsOffline();
                    return;
                }
                
                // Firebase is available, set up listeners
                setupFirebaseListeners();
            }, 2000); // Increased timeout to 2 seconds
        }
        
        function setupFirebaseListeners() {
            try {
                const npkRef = window.firebaseRef(window.firebaseDB, 'npk');
                
                // Listen for NPK data changes
                const listener = window.firebaseOnValue(npkRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        updateNPKInputsFromFirebase(data);
                        showFirebaseSuccess('NPK data loaded from Firebase successfully!');
                    } else {
                        showFirebaseError('No NPK data found in Firebase. Please add data to the database.');
                        setupNPKInputsOffline();
                    }
                }, (error) => {
                    console.error('Firebase read error:', error);
                    showFirebaseError('Error reading from Firebase: ' + error.message);
                    setupNPKInputsOffline();
                });
                
                firebaseListeners.push({ ref: npkRef, listener });
                
            } catch (error) {
                console.error('Firebase setup error:', error);
                showFirebaseError('Firebase setup failed: ' + error.message);
                setupNPKInputsOffline();
            }
        }
        
        function updateNPKInputsFromFirebase(data) {
            console.log('Firebase data received:', data);
            
            // Check if we're using sample data
            if (window.firebaseUsingSampleData) {
                showFirebaseError('CORS restrictions prevent direct Firebase access');
            } else {
                showFirebaseSuccess('NPK data loaded from Firebase successfully!');
            }
            
            // Extract values from Firebase structure
            const nitrogen = data.nitrogen || {};
            const phosphorous = data.phosphorous || {};
            const potassium = data.potassium || {};
            
            if (selectedService === 'drone') {
                // Update drone inputs with Firebase data
                for (let i = 1; i <= 5; i++) {
                    const nInput = document.getElementById(`nitrogen-${i}`);
                    const pInput = document.getElementById(`phosphorous-${i}`);
                    const kInput = document.getElementById(`potassium-${i}`);
                    
                    if (nInput && nitrogen[`setpoint${i}`]) {
                        nInput.value = nitrogen[`setpoint${i}`];
                    }
                    if (pInput && phosphorous[`setpoint${i}`]) {
                        pInput.value = phosphorous[`setpoint${i}`];
                    }
                    if (kInput && potassium[`setpoint${i}`]) {
                        kInput.value = potassium[`setpoint${i}`];
                    }
                }
            } else {
                // Update manual inputs with average values
                const nAvg = document.getElementById('nitrogen-avg');
                const pAvg = document.getElementById('phosphorous-avg');
                const kAvg = document.getElementById('potassium-avg');
                
                if (nAvg && nitrogen.average) {
                    nAvg.value = nitrogen.average;
                }
                if (pAvg && phosphorous.average) {
                    pAvg.value = phosphorous.average;
                }
                if (kAvg && potassium.average) {
                    kAvg.value = potassium.average;
                }
            }
        }
        
        function showFirebaseSuccess(message) {
            const statusDiv = document.getElementById('firebase-status');
            const statusMessage = document.getElementById('status-message');
            const spinner = document.getElementById('loading-spinner');
            
            statusDiv.className = 'firebase-status';
            spinner.style.display = 'none';
            statusMessage.textContent = '‚úÖ ' + message;
            
            // Hide status after 3 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
        
        function showFirebaseError(message) {
            const statusDiv = document.getElementById('firebase-status');
            const statusMessage = document.getElementById('status-message');
            const spinner = document.getElementById('loading-spinner');
            
            statusDiv.className = 'firebase-status error';
            spinner.style.display = 'none';
            statusMessage.innerHTML = `
                ‚ùå ${message}<br>
                <small style="margin-top: 10px; display: block;">
                    <strong>Solution:</strong> To connect to Firebase, serve this HTML file through a web server:<br>
                    ‚Ä¢ Use "python -m http.server 8000" and open http://localhost:8000<br>
                    ‚Ä¢ Or use "npx serve ." if you have Node.js installed<br>
                    <strong>For now:</strong> Using sample NPK data for demonstration
                </small>
            `;
        }
        
        function setupNPKInputsOffline() {
            // Fallback to original functionality if Firebase fails
            if (selectedService === 'drone') {
                // Auto-populate with simulated drone readings
                setTimeout(() => {
                    populateDroneReadings();
                }, 1000);
            }
        }
        
        function cleanupFirebaseListeners() {
            firebaseListeners.forEach(({ ref, listener }) => {
                window.firebaseOff(ref, 'value', listener);
            });
            firebaseListeners = [];
        }
        
        // Debug function to test Firebase connection
        function testFirebaseConnection() {
            const statusDiv = document.getElementById('firebase-status');
            const statusMessage = document.getElementById('status-message');
            const spinner = document.getElementById('loading-spinner');
            
            statusDiv.style.display = 'block';
            statusDiv.className = 'firebase-status loading';
            spinner.style.display = 'inline-block';
            statusMessage.textContent = 'Testing Firebase connection...';
            
            console.log('=== Firebase Connection Test ===');
            console.log('Firebase DB object:', window.firebaseDB);
            console.log('Firebase Error:', window.firebaseError);
            
            if (!window.firebaseDB) {
                showFirebaseError('Firebase database not initialized. Check console for errors.');
                return;
            }
            
            try {
                // Test reading from Firebase
                const testRef = window.firebaseRef(window.firebaseDB, 'npk');
                const testListener = window.firebaseOnValue(testRef, (snapshot) => {
                    const data = snapshot.val();
                    console.log('Firebase test data received:', data);
                    
                    if (data) {
                        showFirebaseSuccess('Firebase connection successful! Data found.');
                    } else {
                        showFirebaseError('Firebase connected but no data found at /npk path.');
                    }
                    
                    // Remove test listener
                    window.firebaseOff(testRef, 'value', testListener);
                }, (error) => {
                    console.error('Firebase test error:', error);
                    showFirebaseError(`Firebase test failed: ${error.message}`);
                    window.firebaseOff(testRef, 'value', testListener);
                });
                
            } catch (error) {
                console.error('Firebase test exception:', error);
                showFirebaseError(`Firebase test exception: ${error.message}`);
            }
        }

        // Utility functions
        function updateStepIndicator(step) {
            for (let i = 1; i <= 6; i++) {
                const dot = document.getElementById(`dot-${i}`);
                if (i <= step) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            }
        }

        function showStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');
            updateStepIndicator(step);
        }

        function nextStep() {
            if (currentStep < 7) {
                currentStep++;
                showStep(currentStep);
                
                if (currentStep === 6) {
                    setupNPKInputs();
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
                
                // Cleanup Firebase listeners when leaving step 6
                if (currentStep === 5) {
                    cleanupFirebaseListeners();
                }
            }
        }

        // Step 1: Login validation
        function validateLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            // Clear previous errors
            document.getElementById('email-error').textContent = '';
            document.getElementById('password-error').textContent = '';
            
            let valid = true;
            
            // Check predefined credentials
            const validCredentials = [
                { email: 'mohamedfazilrazaq@gmail.com', password: 'fazil2024' },
                { email: 'farmer@tnagri.gov.in', password: 'TN2024' },
                { email: 'admin@tnagri.gov.in', password: 'ADMIN2024' },
                { email: 'inspector@tnagri.gov.in', password: 'INSPECT2024' }
            ];
            
            const isValidCredential = validCredentials.some(cred => 
                cred.email === email && cred.password === password
            );
            
            if (!email) {
                document.getElementById('email-error').textContent = 'Email is required';
                valid = false;
            } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                document.getElementById('email-error').textContent = 'Please enter a valid email address';
                valid = false;
            }
            
            if (!password) {
                document.getElementById('password-error').textContent = 'Password is required';
                valid = false;
            } 
            
            if (valid && !isValidCredential) {
                document.getElementById('password-error').textContent = 'Invalid email or password. Please use the valid credentials provided.';
                valid = false;
            }
            
            if (valid) {
                userData.email = email;
                userData.password = password;
                nextStep();
            }
        }

        // Step 2: District validation
        function validateDistrict() {
            const district = document.getElementById('district').value;
            
            if (!district) {
                document.getElementById('district-error').textContent = 'Please select a district';
                return;
            }
            
            userData.district = district;
            document.getElementById('selected-district').textContent = district;
            displayCropSuggestions(district);
            nextStep();
        }

        // Display crop suggestions
        function displayCropSuggestions(district) {
            const suggestions = districtCrops[district] || [];
            const container = document.getElementById('crop-suggestions');
            
            container.innerHTML = suggestions.map(crop => `
                <div class="crop-card">
                    <h3>${crop.name}</h3>
                    <p><strong>Varieties:</strong> ${crop.variety}</p>
                    <p><strong>Sowing Period:</strong> ${crop.period}</p>
                    <p><strong>Duration:</strong> ${crop.duration}</p>
                </div>
            `).join('');
        }

        // Service selection
        function selectService(service) {
            selectedService = service;
            
            // Update card selection
            document.getElementById('drone-card').classList.remove('selected');
            document.getElementById('manual-card').classList.remove('selected');
            document.getElementById(`${service}-card`).classList.add('selected');
            
            // Show unique ID for drone service
            const uniqueIdSection = document.getElementById('unique-id-section');
            if (service === 'drone') {
                const uniqueId = 'DRN' + Date.now().toString().substr(-6) + Math.random().toString(36).substr(2, 3).toUpperCase();
                document.getElementById('service-id').textContent = uniqueId;
                userData.uniqueId = uniqueId;
                uniqueIdSection.style.display = 'block';
            } else {
                uniqueIdSection.style.display = 'none';
            }
            
            document.getElementById('service-continue-btn').disabled = false;
        }

        // Setup NPK inputs
        function setupNPKInputs() {
            const title = document.getElementById('npk-title');
            const nitrogenInputs = document.getElementById('nitrogen-inputs');
            const phosphorousInputs = document.getElementById('phosphorous-inputs');
            const potassiumInputs = document.getElementById('potassium-inputs');
            
            if (selectedService === 'drone') {
                title.textContent = 'üìä Drone Inspection Results - NPK Values';
                
                // Generate drone inputs (5 setpoints each)
                const generateDroneInputs = (element, nutrient, color) => {
                    element.innerHTML = '';
                    for (let i = 1; i <= 5; i++) {
                        const div = document.createElement('div');
                        div.className = 'setpoint-group';
                        div.innerHTML = `
                            <label>Setpoint ${i}:</label>
                            <input type="number" step="0.1" placeholder="${nutrient} value" 
                                   id="${nutrient.toLowerCase()}-${i}" 
                                   style="border-left: 3px solid ${color};">
                        `;
                        element.appendChild(div);
                    }
                };
                
                generateDroneInputs(nitrogenInputs, 'Nitrogen', '#4CAF50');
                generateDroneInputs(phosphorousInputs, 'Phosphorous', '#f44336');
                generateDroneInputs(potassiumInputs, 'Potassium', '#ff9800');
                
                // Initialize Firebase connection for drone service
                initializeFirebaseConnection();
                
            } else {
                title.textContent = 'üìä Manual NPK Entry';
                
                const generateManualInputs = (element, nutrient, color) => {
                    element.innerHTML = `
                        <div class="setpoint-group">
                            <label>Average ${nutrient} Value:</label>
                            <input type="number" step="0.1" placeholder="Enter ${nutrient} value" 
                                   id="${nutrient.toLowerCase()}-avg" 
                                   style="border-left: 3px solid ${color};">
                        </div>
                    `;
                };
                
                generateManualInputs(nitrogenInputs, 'Nitrogen', '#4CAF50');
                generateManualInputs(phosphorousInputs, 'Phosphorous', '#f44336');
                generateManualInputs(potassiumInputs, 'Potassium', '#ff9800');
                
                // For manual entry, try to get Firebase data too
                initializeFirebaseConnection();
            }
        }
        
        function populateDroneReadings() {
            // Simulate realistic NPK readings (fallback)
            const nReadings = [45.2, 42.8, 46.1, 44.5, 43.9];
            const pReadings = [18.3, 19.1, 17.8, 18.9, 18.5];
            const kReadings = [125.4, 123.7, 126.8, 124.2, 125.1];
            
            for (let i = 1; i <= 5; i++) {
                const nInput = document.getElementById(`nitrogen-${i}`);
                const pInput = document.getElementById(`phosphorous-${i}`);
                const kInput = document.getElementById(`potassium-${i}`);
                
                if (nInput) nInput.value = nReadings[i-1];
                if (pInput) pInput.value = pReadings[i-1];
                if (kInput) kInput.value = kReadings[i-1];
            }
        }
        
        function collectNPKData() {
            const data = { nitrogen: [], phosphorous: [], potassium: [] };
            
            if (selectedService === 'drone') {
                for (let i = 1; i <= 5; i++) {
                    data.nitrogen.push(parseFloat(document.getElementById(`nitrogen-${i}`).value) || 0);
                    data.phosphorous.push(parseFloat(document.getElementById(`phosphorous-${i}`).value) || 0);
                    data.potassium.push(parseFloat(document.getElementById(`potassium-${i}`).value) || 0);
                }
            } else {
                data.nitrogen = [parseFloat(document.getElementById('nitrogen-avg').value) || 0];
                data.phosphorous = [parseFloat(document.getElementById('phosphorous-avg').value) || 0];
                data.potassium = [parseFloat(document.getElementById('potassium-avg').value) || 0];
            }
            
            return data;
        }
        
        function calculateAverages(data) {
            const avg = (arr) => arr.reduce((a, b) => a + b, 0) / arr.length;
            return {
                nitrogen: avg(data.nitrogen),
                phosphorous: avg(data.phosphorous),
                potassium: avg(data.potassium)
            };
        }
        
        function getRecommendations(averages) {
            const recommendations = [];
            
            // Nitrogen recommendations
            if (averages.nitrogen < 40) {
                recommendations.push({
                    type: 'Nitrogen Deficiency',
                    status: 'Low',
                    color: '#f44336',
                    action: 'Apply nitrogen-rich fertilizers like Urea (46-0-0) at 100-120 kg/hectare'
                });
            } else if (averages.nitrogen > 60) {
                recommendations.push({
                    type: 'Nitrogen Excess',
                    status: 'High',
                    color: '#ff9800',
                    action: 'Reduce nitrogen application and increase potassium to balance nutrients'
                });
            } else {
                recommendations.push({
                    type: 'Nitrogen Level',
                    status: 'Optimal',
                    color: '#4CAF50',
                    action: 'Maintain current nitrogen levels with regular monitoring'
                });
            }
            
            // Phosphorous recommendations
            if (averages.phosphorous < 15) {
                recommendations.push({
                    type: 'Phosphorous Deficiency',
                    status: 'Low',
                    color: '#f44336',
                    action: 'Apply phosphate fertilizers like DAP (18-46-0) at 50-60 kg/hectare'
                });
            } else if (averages.phosphorous > 25) {
                recommendations.push({
                    type: 'Phosphorous Excess',
                    status: 'High',
                    color: '#ff9800',
                    action: 'Reduce phosphorous application and focus on nitrogen and potassium'
                });
            } else {
                recommendations.push({
                    type: 'Phosphorous Level',
                    status: 'Optimal',
                    color: '#4CAF50',
                    action: 'Maintain current phosphorous levels with balanced fertilization'
                });
            }
            
            // Potassium recommendations
            if (averages.potassium < 100) {
                recommendations.push({
                    type: 'Potassium Deficiency',
                    status: 'Low',
                    color: '#f44336',
                    action: 'Apply potassium fertilizers like MOP (0-0-60) at 40-50 kg/hectare'
                });
            } else if (averages.potassium > 150) {
                recommendations.push({
                    type: 'Potassium Excess',
                    status: 'High',
                    color: '#ff9800',
                    action: 'Reduce potassium application and increase calcium for better uptake'
                });
            } else {
                recommendations.push({
                    type: 'Potassium Level',
                    status: 'Optimal',
                    color: '#4CAF50',
                    action: 'Maintain current potassium levels with regular soil testing'
                });
            }
            
            return recommendations;
        }
        
        function generateReport() {
            const npkData = collectNPKData();
            const averages = calculateAverages(npkData);
            const recommendations = getRecommendations(averages);
            
            userData.npkData = npkData;
            userData.averages = averages;
            userData.recommendations = recommendations;
            
            // Cleanup Firebase listeners
            cleanupFirebaseListeners();
            
            displayFinalReport();
            currentStep = 7;
            showStep(currentStep);
        }
        
        function displayFinalReport() {
            const reportContainer = document.getElementById('final-report');
            const { averages, recommendations } = userData;
            
            const currentDate = new Date().toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            reportContainer.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h3>üåæ Soil NPK Analysis Report</h3>
                    <p><strong>District:</strong> ${userData.district} | <strong>Date:</strong> ${currentDate}</p>
                    ${selectedService === 'drone' ? `<p><strong>Service ID:</strong> ${userData.uniqueId}</p>` : ''}
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0;">
                    <div style="background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%); padding: 20px; border-radius: 15px; text-align: center;">
                        <h4 style="color: #2e7d32;">üü¢ Nitrogen (N)</h4>
                        <div style="font-size: 2em; font-weight: bold; color: #4CAF50; margin: 10px 0;">${averages.nitrogen.toFixed(1)} ppm</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%); padding: 20px; border-radius: 15px; text-align: center;">
                        <h4 style="color: #c62828;">üî¥ Phosphorous (P)</h4>
                        <div style="font-size: 2em; font-weight: bold; color: #f44336; margin: 10px 0;">${averages.phosphorous.toFixed(1)} ppm</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fff3e0 0%, #fce4ec 100%); padding: 20px; border-radius: 15px; text-align: center;">
                        <h4 style="color: #ef6c00;">üü° Potassium (K)</h4>
                        <div style="font-size: 2em; font-weight: bold; color: #ff9800; margin: 10px 0;">${averages.potassium.toFixed(1)} ppm</div>
                    </div>
                </div>
                
                <h4 style="margin: 30px 0 20px 0;">üìã Recommendations:</h4>
                ${recommendations.map(rec => `
                    <div style="background: white; border-left: 5px solid ${rec.color}; padding: 20px; margin: 15px 0; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h5 style="margin: 0; color: #333;">${rec.type}</h5>
                            <span style="background: ${rec.color}; color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold;">${rec.status}</span>
                        </div>
                        <p style="margin: 0; color: #666;">${rec.action}</p>
                    </div>
                `).join('')}
                
                <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 20px; border-radius: 15px; margin-top: 30px;">
                    <h4 style="color: #1565c0; margin-bottom: 15px;">üìä Analysis Summary:</h4>
                    <ul style="color: #333; line-height: 1.6;">
                        <li><strong>Measurement Method:</strong> ${selectedService === 'drone' ? 'Professional Drone Inspection (5 setpoints)' : 'Manual Entry'}</li>
                        <li><strong>Soil Health Status:</strong> ${getOverallStatus(recommendations)}</li>
                        <li><strong>Primary Action Required:</strong> ${getPrimaryAction(recommendations)}</li>
                        <li><strong>Next Inspection:</strong> Recommended in 3-4 months</li>
                    </ul>
                </div>
            `;
        }
        
        function getOverallStatus(recommendations) {
            const optimalCount = recommendations.filter(r => r.status === 'Optimal').length;
            if (optimalCount === 3) return 'Excellent - All nutrients balanced';
            if (optimalCount === 2) return 'Good - Minor adjustments needed';
            if (optimalCount === 1) return 'Fair - Nutrient management required';
            return 'Poor - Immediate intervention needed';
        }
        
        function getPrimaryAction(recommendations) {
            const deficient = recommendations.find(r => r.status === 'Low');
            if (deficient) return deficient.action;
            
            const excess = recommendations.find(r => r.status === 'High');
            if (excess) return excess.action;
            
            return 'Continue current nutrient management practices';
        }
        
        function exportReport() {
            const reportContent = document.getElementById('final-report').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>NPK Analysis Report - ${userData.district}</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            h3, h4, h5 { color: #333; }
                            .no-print { display: none; }
                        </style>
                    </head>
                    <body>
                        ${reportContent}
                        <div style="margin-top: 30px; text-align: center; color: #666;">
                            <p>Generated by Crop Suggestion & NPK Inspection System</p>
                            <p>Tamil Nadu Agriculture Department</p>
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        function restartProcess() {
            currentStep = 1;
            selectedService = '';
            userData = {};
            
            // Cleanup Firebase listeners
            cleanupFirebaseListeners();
            
            // Reset form fields
            document.getElementById('email').value = 'mohamedfazilrazaq@gmail.com';
            document.getElementById('password').value = 'fazil2024';
            document.getElementById('district').value = '';
            
            // Clear errors
            document.querySelectorAll('.error').forEach(el => el.textContent = '');
            
            // Hide Firebase status
            document.getElementById('firebase-status').style.display = 'none';
            
            showStep(1);
        }
        
        // Set default inspection dates
        function setDefaultDates() {
            const today = new Date();
            const nitrogenDate = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000); // +7 days
            const phosphorousDate = new Date(today.getTime() + 14 * 24 * 60 * 60 * 1000); // +14 days
            const potassiumDate = new Date(today.getTime() + 21 * 24 * 60 * 60 * 1000); // +21 days
            
            document.getElementById('nitrogen-date').value = nitrogenDate.toISOString().split('T')[0];
            document.getElementById('phosphorous-date').value = phosphorousDate.toISOString().split('T')[0];
            document.getElementById('potassium-date').value = potassiumDate.toISOString().split('T')[0];
        }
        
        // Initialize when page loads
        window.addEventListener('load', function() {
            setDefaultDates();
        });
    </script>
</body>
</html>
